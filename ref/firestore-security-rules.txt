rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isAdmin() {
      return signedIn() &&
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    match /admins/{uid} {
      allow read: if isAdmin();
      allow write: if false; // console-only for MVP
    }

    // Full order data: admin only
    match /orders/{orderId} {
      allow read, write: if isAdmin();
    }

    // Token tracking doc: token holders can read/write this doc
    match /publicTracking/{token} {
      allow read: if true;

      // Allow writes, but limit fields to prevent someone from turning it into a database dump.
      allow create, update: if request.resource.data.diff(resource.data).changedKeys().hasOnly([
        "status","updatedAt","address","tracking","paid","photos","messages","orderId","customerName"
      ]);
    }
  }
}
